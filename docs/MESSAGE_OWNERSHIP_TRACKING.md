# Message Ownership Tracking

## Overview
The system tracks message ownership to distinguish between customer messages, bot responses, and human agent messages sent from the dashboard. This enables proper message attribution in chat interfaces and analytics.

## Message Types

### 1. Customer Messages
Messages sent by customers through Facebook Messenger.
- `is_bot`: false
- `is_human`: false
- `source`: "facebook" (optional)

### 2. Bot Messages
Automated responses generated by the AI bot.
- `is_bot`: true
- `is_human`: false
- `source`: "bot" (optional)

### 3. Human Agent Messages
Messages sent by human agents through the dashboard.
- `is_bot`: false
- `is_human`: true
- `source`: "dashboard"
- Includes agent details: `agent_id`, `agent_email`, `agent_name`

## Database Schema

### Message Model Fields
```go
type Message struct {
    // ... other fields ...
    IsBot      bool   `bson:"is_bot" json:"is_bot"`           // Always included in JSON
    IsHuman    bool   `bson:"is_human" json:"is_human"`       // Always included in JSON
    Source     string `bson:"source,omitempty" json:"source,omitempty"`
    AgentID    string `bson:"agent_id,omitempty" json:"agent_id,omitempty"`
    AgentEmail string `bson:"agent_email,omitempty" json:"agent_email,omitempty"`
    AgentName  string `bson:"agent_name,omitempty" json:"agent_name,omitempty"`
}
```

## API Endpoints

### GET /api/dashboard/messages/conversation/:customerID
Returns conversation with message ownership tracking.

**Query Parameters:**
- `page_id` (required): Facebook page ID
- `page`: Page number (default: 1)
- `limit`: Messages per page (default: 50, max: 200)

**Response Structure:**
```json
{
    "customer_id": "8708957485860081",
    "customer_name": "John Doe",
    "page_id": "461998383671026",
    "page_name": "My Page",
    "conversation": [
        {
            "id": "68a445a5124e1653409f0718",
            "message": "Hello, I need help",
            "timestamp": "2025-08-19T09:36:37.166Z",
            "is_bot": false,
            "is_human": false,
            "sender_id": "8708957485860081",
            "recipient_id": "461998383671026",
            "type": "customer",
            "sender_name": "John Doe"
        },
        {
            "id": "68a445a5124e1653409f0719",
            "message": "Hello! How can I help you today?",
            "timestamp": "2025-08-19T09:36:38.166Z",
            "is_bot": true,
            "is_human": false,
            "sender_id": "461998383671026",
            "recipient_id": "8708957485860081",
            "type": "bot",
            "sender_name": "My Page"
        },
        {
            "id": "68a445a5124e1653409f0720",
            "message": "Let me assist you with that issue",
            "timestamp": "2025-08-19T09:36:40.166Z",
            "is_bot": false,
            "is_human": true,
            "sender_id": "461998383671026",
            "recipient_id": "8708957485860081",
            "type": "bot",
            "sender_name": "My Page",
            "agent_id": "user123",
            "agent_email": "agent@example.com",
            "agent_name": "Jane Smith"
        }
    ],
    "pagination": {
        "page": 1,
        "limit": 50,
        "total": 3,
        "total_pages": 1,
        "has_more": false
    }
}
```

### GET /api/dashboard/messages/chat/:chatID
Returns messages with full ownership details.

**Query Parameters:**
- `page_id` (required): Facebook page ID
- `page`: Page number (default: 1)
- `limit`: Messages per page (default: 50, max: 200)

**Response:** Returns array of Message objects with all ownership fields.

## Implementation Details

### When Agents Send Messages

#### Via WebSocket (Real-time)
```go
// handlers/websocket_handler.go
messageDoc := &models.Message{
    // ... other fields ...
    IsBot:      false,
    IsHuman:    true,
    Source:     "dashboard",
    AgentID:    conn.UserID,
    AgentEmail: conn.UserEmail,
    AgentName:  conn.UserName,
}
```

#### Via HTTP API
```go
// handlers/customer_handler.go - SendMessageToCustomer endpoint
messageDoc := &models.Message{
    // ... other fields ...
    IsBot:      false,
    IsHuman:    true,
    AgentID:    agentID,    // From JWT session
    AgentEmail: agentEmail, // From JWT session
    AgentName:  agentName,  // From JWT session
}
```

### When Bot Sends Messages
```go
// handlers/message_handler.go
botMessageDoc := &models.Message{
    // ... other fields ...
    IsBot:   true,
    IsHuman: false,
    Source:  "bot",
}
```

### When Customers Send Messages
```go
// handlers/message_handler.go
customerMessageDoc := &models.Message{
    // ... other fields ...
    IsBot:   false,
    IsHuman: false,
    Source:  "facebook",
}
```

## Frontend Implementation Guide

### Identifying Message Sender
```javascript
function getMessageSender(message) {
    if (message.is_bot) {
        return 'bot';
    } else if (message.is_human) {
        return 'agent';
    } else {
        return 'customer';
    }
}

function renderMessage(message) {
    const sender = getMessageSender(message);
    
    switch(sender) {
        case 'customer':
            // Render as customer message (typically right-aligned)
            return renderCustomerMessage(message);
        
        case 'bot':
            // Render as bot message (typically left-aligned with bot indicator)
            return renderBotMessage(message);
        
        case 'agent':
            // Render as agent message (typically left-aligned with agent info)
            return renderAgentMessage(message, {
                agentName: message.agent_name,
                agentEmail: message.agent_email
            });
    }
}
```

### Display Agent Information
When `is_human` is true, additional agent information is available:

```javascript
if (message.is_human) {
    console.log(`Message sent by agent: ${message.agent_name} (${message.agent_email})`);
    // Display agent avatar or badge
    // Show "Sent by [Agent Name]" tooltip
}
```

## Agent Handoff Behavior

When a customer requests to speak with a human agent:
1. The system detects the request (via AI or keyword detection)
2. Customer's `stop` status is set to `true`
3. **No automated message is sent to the customer**
4. Agents are notified via WebSocket broadcast
5. The conversation appears in the agent dashboard for manual handling

This silent handoff ensures:
- No confusing automated responses during handoff
- Smooth transition from bot to human
- Customer's request is immediately visible to agents

## Best Practices

1. **Always check both `is_bot` and `is_human` fields** to determine message ownership
2. **Display agent information** when available to maintain transparency
3. **Use different visual styles** for customer, bot, and agent messages
4. **Include timestamps** to show message chronology
5. **Handle the silent handoff** - no message sent when customer requests agent

## Testing

### Test Scenarios
1. **Customer Message**: Send message from Facebook Messenger
   - Verify: `is_bot: false, is_human: false`

2. **Bot Response**: Trigger automated response
   - Verify: `is_bot: true, is_human: false`

3. **Agent Message**: Send message from dashboard
   - Verify: `is_bot: false, is_human: true`
   - Verify: Agent details are included

4. **Agent Handoff**: Customer requests human agent
   - Verify: No automated message sent
   - Verify: Agent notification received
   - Verify: Customer status updated

## Troubleshooting

### Missing `is_human` field
- Ensure the server has been restarted after code changes
- Check that the Message model doesn't have `omitempty` tag on `IsHuman` field
- Verify the endpoint is using the updated handler

### Agent details not appearing
- Confirm JWT session contains agent information
- Check that agent is properly authenticated
- Verify `IsHuman` is set to `true` for agent messages

### Messages attributed incorrectly
- Review the logic for setting `IsBot` and `IsHuman` flags
- Check `SenderID` and `RecipientID` mapping
- Ensure proper message source tracking